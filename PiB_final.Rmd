---
title: "KM fibril injection PIB"
author: "PPS/NRR"
date: "6/15/2020"
output: 
 html_document:
  toc: true 
  toc_float: true 
  toc_depth: 3
  
---
```{r setup}
library(kinfitr)
library(mgcv) 
library(granviller) 
library(tidyverse)

#Load raw data from GitHub 
rawdata_url <- ("https://github.com/nakulrrraval/Protien_inj_pig_model_PIB/raw/PET/alldat_raw.RDS")
alldat <- readRDS(url(rawdata_url, method="libcurl"))
```

```{r Modelling blood curves, eval=T}
set.seed(12345)

meanBIC <- alldat %>% 
  filter(Subjname != 'pib007_p228' & Subjname != 'pib006_p220', Subjname != 'pib005_p199' ) %>% #remove the  that only have  pop-parent-fraction 
  group_by(Subjname) %>%
  #extract the metabolite data into their "own dataframes" 
  mutate(pfdat = map(blooddata, 
                ~bd_extract(.x, output = "parentFraction",what = "raw")),
         #fit metabolite data using different models       
         hillmodel = map(pfdat,
                ~metab_hill(.x$time, .x$parentFraction, multstart_iter = 500)),
         hillgaumodel = map(pfdat,
                ~metab_hillguo(.x$time, .x$parentFraction, multstart_iter = 500)),
         powmodel = map(pfdat,
                ~metab_power(.x$time, .x$parentFraction, multstart_iter = 500)),
         invgammamodel = map(pfdat,
                ~metab_invgamma(.x$time, .x$parentFraction, multstart_iter = 500)),
         expmodel = map(pfdat,
                ~metab_exponential(.x$time, .x$parentFraction, multstart_iter = 500)),
         
         #Extract the information criteria for each model 
         hillmodel.BIC= unlist(map(hillmodel, ~BIC(.x))),
         pow.BIC = unlist(map(powmodel, ~BIC(.x))),
         invgamma.BIC = unlist(map(invgammamodel, ~BIC(.x))),
         exp.BIC = unlist(map(expmodel, ~BIC(.x)))
         
         ) %>%
  ungroup() %>%
#Calculate the mean information criteria for each model over all subjects
  summarise(hillmodel.meanBIC = mean(hillmodel.BIC),
            pow.meanBIC = mean(pow.BIC), 
             invgamma.meanBIC = mean(invgamma.BIC),
             exp.meanBIC = mean(exp.BIC))
             
#output the meaninformation criteria as table
 knitr::kable(x = data.frame(
    Model = c('hill', 'Power','Inverse gamma','Exponential'),
    meanBIC = as.vector(unlist( meanBIC[]))),
    digits = 3, caption = "Bayesian Information Criteria")
```

```{r Create weights for brain TAC}
#Function to create weights
create_weights <- function(tacs)
  {
  new_weights <- kinfitr::weights_create(t_start = tacs$Times[1],
                          t_end = tacs$Times[length(tacs$Times)],
                          tac = tacs$Neo.cx,
                          radioisotope = c("C11"),
                          method = 2,
                          minweight = 0.7)
  tacs$Weights <- new_weights
  return(tacs)
}

#Apply function to create weights
alldat <- alldat %>%
  mutate( tacs = purrr::pmap(.l = list(tacs), .f = create_weights))
```

```{r PF model invgamma, eval=T}
set.seed(12345)

alldat <- alldat %>% 
  group_by(Subjname) %>% 
  mutate(pfdat = map(blooddata, 
                ~bd_extract(.x, output = "parentFraction", what = "raw")),
         invgamma = map(pfdat,
                ~metab_invgamma(.x$time, .x$parentFraction, multstart_iter = 10000)),
         blooddata = map2(blooddata, invgamma,
                ~bd_addfit(.x, .y, modeltype = "parentFraction"))) %>%
  select(-pfdat) #remove the extracted parent-fraction data to keep the alldat df tidy  
```

```{r Calculate AIF}
#Calculate AIF 
alldat %<>% 
  group_by(Subjname) %>% 
  mutate(input = map(blooddata, ~bd_create_input(blooddata = .x) )) %>%
  ungroup()
```

```{r input shift}
#Function to calculate the input function delay
inpshift_profiler <- function(Subj, tacs, input)
  {
  p1 <- kinfitr::lin2tcm_inpshiftProfile(t_tac = tacs$Times, 
         tac = tacs$Neo.cx, 
         input = input, 
         weights = tacs$Weights,
         vB = 0.05)
  inpshift <- p1$data$inpshift[which.min(p1$data$log_RSS)]
}

#Apply function to calculate the input function delay
alldat <- alldat %>%
  mutate( inpshift = pmap_dbl( .l = list(Subjname, tacs, input) , .f = inpshift_profiler ))  
```

```{r k2prime estimation SRTM}
#Ungroup data for SRTM
alldatref_srtm <- alldat %>%
  select(Subjname, tacs) %>%
  unnest() %>%
  select(c( Subjname, Times, Weights,
            inj1,
            inj2,
            Occipital.cx)) %>%
  gather(Region, TAC, -c(Subjname, Times, Weights, Occipital.cx)) %>%
  group_by(Subjname, Region) %>%
  nest(.key = 'tacs')

#Function to fit SRTM1
k2pEst_srtm <- function(tacs)
  {
  
 kinfitr::srtm(t_tac = tacs$Times, 
                reftac = tacs$Occipital.cx,
                roitac = tacs$TAC,
                weights = tacs$Weights,
               multstart_iter = 5)
}

#Apply function to fit SRTM1
alldatref_srtm_only_high_injreg <- alldatref_srtm %>% #Only high (AD homo) and medium (asyn PFF) binding regions are included
  filter(Subjname == 'pib001_p84' & Region == 'inj1' | 
            Subjname == 'pib002_p89' & Region == 'inj1'|
            Subjname == 'pib004_p102' & Region == 'inj1'|
            Subjname == 'pib005_p199' & Region == 'inj1'|
            Subjname == 'pib001_p84' & Region == 'inj2'|
            Subjname == 'pib006_p220' & Region == 'inj2'|
            Subjname == 'pib007_p228' & Region == 'inj2') %>%
  mutate(srtm.fit = map(.x = tacs,.f = k2pEst_srtm)) %>%
  mutate(BP.srtm = map_dbl(srtm.fit, c("par", "bp"))) %>%
  mutate(k2.srtm = map_dbl(srtm.fit, c("par", "k2"))) %>%
  mutate(R1.srtm = map_dbl(srtm.fit, c("par", "R1"))) %>%
  mutate(k2.prime.srtm = k2.srtm/R1.srtm)
```

```{r SRTM2}
#Ungroup data for SRTM2
alldatref_srtm2 <- alldat %>%
  select(Subjname, tacs) %>%
  unnest() %>%
  select(c( Subjname, Times, Weights, 
            #Neo.cx,
            inj1,
            inj2,
            Cerebellum,
            Occipital.cx)) %>%
  gather(Region, TAC, -c(Subjname, Times, Weights, Occipital.cx)) %>%
  group_by(Subjname, Region) %>%
  nest(.key = 'tacs')

#Function to fit SRTM2
srtm2.func <- function(tacs)
  {
  
 kinfitr::srtm2(t_tac = tacs$Times, 
                reftac = tacs$Occipital.cx,
                roitac = tacs$TAC,
                weights = tacs$Weights,
                k2prime = 0.03)
}

#Apply function to fit SRTM2
alldatref_srtm2 <- alldatref_srtm2 %>%
  mutate(srtm2.fit = map(.x = tacs,.f = srtm2.func)) %>%
  mutate(BP.srtm2 = map_dbl(srtm2.fit, c("par", "bp")))
```


```{r Logan Plot}
#Ungroup TAC data
alldatLogan <- alldat %>%
  select(Subjname, tacs) %>%
  unnest() %>%
  select(c( Subjname, Times, Weights,
            Occipital.cx, 
            inj1,
            inj2,
            Cerebellum)) %>% #select the Regions to model
  gather(Region, TAC, -c(Subjname, Times, Weights)) %>%
  group_by(Subjname, Region) %>%
  nest(.key = 'tacs')

#Merge back blood data and delay fit
alldatLogan <- alldat %>%
  select(Subjname, blooddata, input, inpshift) %>%
  left_join(alldatLogan, .) 

#Function to fit Logan plot
fitlogan <- function(tacs, input, inpshift) 
  {
  Loganplot(t_tac = tacs$Times, 
         tac = tacs$TAC, 
         input = input, 
         tstarIncludedFrames = 10,
         weights = tacs$Weights,
         inpshift = inpshift, 
         vB = 0.05) 
  }

#Apply function to fit Logan plot
alldatLogan <- alldatLogan %>%  
  mutate(fit_logan = pmap(list(tacs, input, inpshift), .f = fitlogan)) %>%
  mutate(Vt.logan = map_dbl(fit_logan, c('par', 'Vt')))

```
